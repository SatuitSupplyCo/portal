name: Infrastructure

on:
  pull_request:
    branches: [main]
    paths:
      - "infra/**"
      - ".github/workflows/deploy-infra.yml"
  push:
    branches: [main]
    paths:
      - "infra/**"
      - ".github/workflows/deploy-infra.yml"
  workflow_dispatch:
    inputs:
      action:
        description: "Terraform action to run"
        required: true
        default: plan
        type: choice
        options:
          - plan
          - apply

concurrency:
  group: terraform
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: "1.10.3"

jobs:
  # ── Stack 1: Shared Services (ECR, IAM) ───────────────────────────────────
  shared-services:
    name: "Shared Services"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infra/shared-services
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS credentials (shared-services)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::126710469812:role/gha-infra-deploy-shared
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init -input=false

      - name: Terraform Format Check
        run: terraform fmt -check

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -input=false -no-color -out=tfplan

      - name: Save plan output
        if: always() && github.event_name == 'pull_request'
        run: |
          if [ -f tfplan ]; then
            terraform show -no-color tfplan > "$RUNNER_TEMP/plan.txt"
          else
            echo "Plan failed — see job logs for details." > "$RUNNER_TEMP/plan.txt"
          fi

      - name: Upload plan
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-shared-services
          path: ${{ runner.temp }}/plan.txt
          retention-days: 5

      - name: Terraform Apply
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.action == 'apply')
        run: terraform apply -input=false -auto-approve tfplan

  # ── Stack 2: Prod Infrastructure (VPC, ECS, ALB, RDS, Redis, DNS, IAM) ────
  prod-infra:
    name: "Prod Infrastructure"
    needs: shared-services
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infra/prod/infra
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS credentials (prod)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::095194426970:role/gha-infra-deploy-prod
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init -input=false

      - name: Terraform Format Check
        run: terraform fmt -check

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -input=false -no-color -out=tfplan

      - name: Save plan output
        if: always() && github.event_name == 'pull_request'
        run: |
          if [ -f tfplan ]; then
            terraform show -no-color tfplan > "$RUNNER_TEMP/plan.txt"
          else
            echo "Plan failed — see job logs for details." > "$RUNNER_TEMP/plan.txt"
          fi

      - name: Upload plan
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-prod-infra
          path: ${{ runner.temp }}/plan.txt
          retention-days: 5

      - name: Terraform Apply
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.action == 'apply')
        run: terraform apply -input=false -auto-approve tfplan

  # ── Stack 3: Prod Apps (ECS services, target groups, DNS) ─────────────────
  prod-apps:
    name: "Prod Apps"
    needs: prod-infra
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infra/prod/apps
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS credentials (prod)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::095194426970:role/gha-infra-deploy-prod
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init -input=false

      - name: Terraform Format Check
        run: terraform fmt -check

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -input=false -no-color -out=tfplan

      - name: Save plan output
        if: always() && github.event_name == 'pull_request'
        run: |
          if [ -f tfplan ]; then
            terraform show -no-color tfplan > "$RUNNER_TEMP/plan.txt"
          else
            echo "Plan failed — see job logs for details." > "$RUNNER_TEMP/plan.txt"
          fi

      - name: Upload plan
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-prod-apps
          path: ${{ runner.temp }}/plan.txt
          retention-days: 5

      - name: Terraform Apply
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.action == 'apply')
        run: terraform apply -input=false -auto-approve tfplan

  # ── PR Comment ────────────────────────────────────────────────────────────
  comment:
    name: "Post Plan to PR"
    if: always() && github.event_name == 'pull_request'
    needs: [shared-services, prod-infra, prod-apps]
    runs-on: ubuntu-latest
    steps:
      - name: Download all plans
        uses: actions/download-artifact@v4
        with:
          pattern: tfplan-*
          path: plans

      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const stacks = [
              { key: 'shared-services', label: 'Shared Services', result: '${{ needs.shared-services.result }}' },
              { key: 'prod-infra', label: 'Prod Infrastructure', result: '${{ needs.prod-infra.result }}' },
              { key: 'prod-apps', label: 'Prod Apps', result: '${{ needs.prod-apps.result }}' },
            ];

            let body = '## Terraform Plan\n\n';

            for (const { key, label, result } of stacks) {
              let plan = '';
              let icon = '';

              try {
                plan = fs.readFileSync(`plans/tfplan-${key}/plan.txt`, 'utf8').trim();
                if (plan.includes('No changes')) {
                  icon = '✅';
                } else if (result === 'success') {
                  icon = '⚠️';
                } else {
                  icon = '❌';
                }
              } catch {
                plan = result === 'skipped'
                  ? 'Skipped — a dependency failed.'
                  : 'Plan output not available — see job logs.';
                icon = result === 'skipped' ? '⏭️' : '❌';
              }

              const summary = plan.includes('No changes') ? ' — No changes' : '';
              body += `<details><summary>${icon} <b>${label}</b>${summary}</summary>\n\n\`\`\`\n${plan}\n\`\`\`\n</details>\n\n`;
            }

            body += `\n*Commit: \`${context.sha.substring(0, 8)}\` · Actor: @${context.actor}*`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c =>
              c.user?.type === 'Bot' && c.body?.startsWith('## Terraform Plan')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
